{% extends 'base.html' %}
{% block content %}
<div class="container my-4">
  {% if slot %}
  <!-- Booking Single Slot -->
  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <h5 class="card-title mb-2 text-primary">
        <i class="bi bi-person-circle"></i> {{ slot.doctor_name }}
      </h5>
      <div class="text-muted small mb-2">
        <i class="bi bi-hospital"></i> {{ slot.clinic_name }}
      </div>
      <div class="mb-2">
        <i class="bi bi-calendar-event"></i> {{ slot.date }} at {{ slot.time }}
      </div>
      <div class="mb-2">
        <i class="bi bi-currency-rupee"></i> {{ slot.fees }}
      </div>
      <form method="post">
        <button class="btn btn-primary">Confirm Booking</button>
      </form>
    </div>
  </div>

  {% else %}
  <!-- Doctor Detail Page -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
      <div class="d-flex align-items-center mb-2">
        <span class="rounded-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center" style="width:56px; height:56px;">
          <i class="bi bi-person-circle" style="font-size:2.5rem; color:#0d6efd;"></i>
        </span>
        <div class="ms-3">
          <h4 class="mb-0 text-primary">{{ doc.name }}</h4>
          <div class="text-muted small">{{ doc.specialization }}</div>
          <!-- ⭐ Average Rating -->
          <div class="small mt-1">
            <i class="bi bi-star-fill" style="color:#ffc107;"></i>
            {% if doc.average_rating and doc.average_rating > 0 %}
              {{ "%.1f"|format(doc.average_rating) }} / 5
            {% else %}
              No ratings yet
            {% endif %}
          </div>
        </div>
      </div>
      <div class="mb-1 text-muted"><i class="bi bi-hospital"></i> {{ doc.clinic_name }} - {{ doc.clinic_city }}</div>
      <div class="mb-1 text-muted"><i class="bi bi-geo-alt"></i> {{ doc.address }}</div>
      <div class="mb-1 text-muted"><i class="bi bi-currency-rupee"></i> {{ doc.fees }}</div>
      {% if doc.about %}
      <p class="mt-2 small text-secondary">{{ doc.about }}</p>
      {% endif %}
    </div>
  </div>

  <!-- Available Slots -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-light fw-semibold">
      <i class="bi bi-calendar-check"></i> Available Slots
    </div>
    <div class="card-body">
      {% if slots %}
        <div class="list-group">
          {% for slot in slots %}
            {% if slot.booked_count < slot.capacity %}
              <a href="{{ url_for('book', slot_id=slot.id) }}" 
                class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                <div>
                  <i class="bi bi-clock"></i> {{ slot.date }} - {{ slot.time }}
                </div>
                <span class="badge bg-primary rounded-pill">Book</span>
              </a>
            {% else %}
              <div class="list-group-item d-flex justify-content-between align-items-center disabled text-muted">
                <div>
                  <i class="bi bi-clock"></i> {{ slot.date }} - {{ slot.time }}
                </div>
                <span class="badge bg-secondary rounded-pill">Full</span>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      {% else %}
        <div class="text-muted">No slots available.</div>
      {% endif %}
    </div>
  </div>

  <!-- Reviews Section -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-light fw-semibold">
      <i class="bi bi-chat-left-text"></i> Patient Reviews
    </div>
    <div class="card-body">
      {% if reviews %}
        {% for r in reviews %}
        <div class="mb-3 pb-2 border-bottom">
          <div class="d-flex align-items-center mb-1">
            <i class="bi bi-person-circle me-2" style="font-size:1.5rem; color:#0d6efd;"></i>
            <strong>{{ r.patient_name }}</strong>
            <span class="ms-2 small text-muted">{{ r.created_at }}</span>
          </div>
          <div class="small mb-1">
            <i class="bi bi-star-fill" style="color:#ffc107;"></i> {{ r.rating }} / 5
          </div>
          {% if r.comment %}
          <p class="small mb-0">{{ r.comment }}</p>
          {% endif %}
        </div>
        {% endfor %}
      {% else %}
        <div class="text-muted">No reviews yet. Be the first to review this doctor.</div>
      {% endif %}
    </div>
  </div>

  <!-- Leave Review (only for logged-in patients) -->
  {% if session.patient_id %}
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-light fw-semibold">
      <i class="bi bi-pencil-square"></i> Leave a Review
    </div>
    <div class="card-body">
      <form method="post" action="{{ url_for('review') }}">
        <input type="hidden" name="doctor_id" value="{{ doc.id }}">
        <div class="mb-3">
          <label class="form-label">Rating</label>
          <select name="rating" class="form-select" required>
            <option value="">Select rating</option>
            <option value="5">⭐⭐⭐⭐⭐ - Excellent</option>
            <option value="4">⭐⭐⭐⭐ - Good</option>
            <option value="3">⭐⭐⭐ - Average</option>
            <option value="2">⭐⭐ - Poor</option>
            <option value="1">⭐ - Terrible</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Comment (optional)</label>
          <textarea name="comment" class="form-control" rows="2"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Submit Review</button>
      </form>
    </div>
  </div>
  {% endif %}
  {% endif %}
</div>
{% endblock %}
